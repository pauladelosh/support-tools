#!/usr/bin/env php
<?php
$result_dir = $_SERVER['HOME'] . '/.ah';
@mkdir($result_dir, 0777, TRUE);
$result_file = $result_dir . '/ah_' . rand(0,9999999);
$script = array_shift($argv);
$cache = FALSE;
$clear = FALSE;
foreach ($argv as $arg_key => &$tmp_arg) {
  if ($tmp_arg == '--cache') {
    $cache = TRUE;
    unset($argv[$arg_key]);
  }
  else if ($tmp_arg == '--cache-clear') {
    $cache = TRUE;
    $clear = TRUE;
    unset($argv[$arg_key]);
  }
  else if ($tmp_arg == '--autocomplete') {
    $cache = TRUE;
  }
  else if (preg_match('|\s|', $tmp_arg)) {
    $tmp_arg = escapeshellarg(escapeshellarg($tmp_arg));
  }
}

if ($cache) {
  $key = sha1(json_encode(array('aht', $argv)));
  $result_file = $result_dir . '/ah_' . $key;

  if ($clear) {
    @unlink($result_file);
  }

  if (file_exists($result_file) && filemtime($result_file) < (time() + 86400)) {
    echo file_get_contents($result_file);
    exit;
  }
}

$ahtools_path = getenv('AHTPATH');
$ahtools_envs = getenv('AHSTAGES');
$stages = empty($ahtools_envs) ? '' : "--stages={$ahtools_envs}";
if (empty($ahtools_path)) {
  $ahtools_path = 'support_bin';
}
elseif (strtolower($ahtools_path) == 'test') {
  $ahtools_path = 'support_bin_test';
}
$command = "ssh -tq bastion /vol/ebs1/ahsupport/{$ahtools_path}/ahtools {$stages} " . implode(' ', $argv);
passthru($command, $return_code);
exit($return_code);
