#!/usr/bin/env php
<?php
$result_dir = $_SERVER['HOME'] . '/.ah';
@mkdir($result_dir, 0777, TRUE);
$result_file = $result_dir . '/ah_' . rand(0,9999999);
$script = array_shift($argv);
$cache = FALSE;
$clear = FALSE;
foreach ($argv as $arg_key => &$tmp_arg) {
  if ($tmp_arg == '--cache') {
    $cache = TRUE;
    unset($argv[$arg_key]);
  }
  else if ($tmp_arg == '--cache-clear') {
    $cache = TRUE;
    $clear = TRUE;
    unset($argv[$arg_key]);
  }
  else if ($tmp_arg == '--autocomplete') {
    $cache = TRUE;
  }
  else if (preg_match('|\s|', $tmp_arg)) {
    $tmp_arg = escapeshellarg(escapeshellarg($tmp_arg));
  }
}

if ($cache) {
  $key = sha1(json_encode(array('ahdc', $argv)));
  $result_file = $result_dir . '/ah_' . $key;

  if ($clear) {
    @unlink($result_file);
  }

  if (file_exists($result_file) && filemtime($result_file) < (time() + 86400)) {
    echo file_get_contents($result_file);
    exit;
  }
}

// Trying to export the columns using stty.
exec('stty size 2>&1', $columns_output, $columns_status);
if (!$columns_status) $columns = preg_replace('/\d+\s(\d+)/', '$1', $columns_output[0], -1, $columns_count);

// Failling back to default columns value
if (empty($columns)) {
  $columns = 80;
}

$command = 'ssh -tq bastion /vol/ebs1/ahsupport/support_bin/ah ahdc ' . $columns . ' ' . implode(' ', $argv);
passthru($command, $return_code);
exit($return_code);
